name: Build APK for Android 6.0

on:
  workflow_dispatch: # Allows manual triggering only

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'

    - name: Set up Android SDK
      uses: android-actions/setup-android@v3

    - name: Check current minSdk and configure
      id: check_sdk
      run: |
        # Find the current minSdk value in the build file
        if grep -q "minSdk = " app/build.gradle.kts; then
          CURRENT_SDK=$(grep "minSdk = " app/build.gradle.kts | grep -o '[0-9]*')
        elif grep -q "minSdkVersion" app/build.gradle.kts; then
          CURRENT_SDK=$(grep "minSdkVersion" app/build.gradle.kts | grep -o '[0-9]*' | head -1)
        else
          echo "Could not find minSdk in build.gradle.kts"
          exit 1
        fi
        
        echo "Current minSdk is: $CURRENT_SDK"
        
        # Determine if we need to change it
        if [ "$CURRENT_SDK" -le 23 ]; then
          echo "Current minSdk ($CURRENT_SDK) is <= 23. Building without changes."
          echo "sdk_changed=false" >> $GITHUB_OUTPUT
        else
          echo "Current minSdk ($CURRENT_SDK) is > 23. Setting to 23 for this build."
          echo "sdk_changed=true" >> $GITHUB_OUTPUT
          
          # Create a backup and change minSdk to 23
          cp app/build.gradle.kts app/build.gradle.kts.backup
          sed -i "s/minSdk = $CURRENT_SDK/minSdk = 23/" app/build.gradle.kts || \
          sed -i "s/minSdkVersion = $CURRENT_SDK/minSdkVersion = 23/" app/build.gradle.kts || \
          echo "Manual update may be needed. Check build.gradle.kts structure."
        fi

    - name: Build Release APK
      run: |
        chmod +x gradlew
        ./gradlew assembleRelease

    - name: Restore original build file (if changed)
      if: steps.check_sdk.outputs.sdk_changed == 'true'
      run: |
        mv app/build.gradle.kts.backup app/build.gradle.kts

    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: stormy-apk-android6
        path: app/build/outputs/apk/release/app-release.apk
        retention-days: 7
