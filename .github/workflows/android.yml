name: ðŸš€ Stormy APK Production

# ALL TRIGGERS as requested
on:
  workflow_dispatch:           # Manual trigger
  push:                        # Auto on push
  pull_request:                # Auto on PR
  schedule:
    - cron: '0 0 * * 0'       # Weekly build (Sunday midnight)

# PREVENT CONCURRENT BUILDS ON SAME BRANCH
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    # 1. CHECKOUT - with full history for version tagging
    - name: ðŸ“¦ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    # 2. JDK SETUP
    - name: â˜• Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    # 3. ANDROID SETUP with caching
    - name: ðŸ¤– Set up Android SDK
      uses: android-actions/setup-android@v3
      
    - name: ðŸ’¾ Cache Gradle
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          gradle-${{ runner.os }}-
          
    # 4. SMART SDK VERSION HANDLING (error prevention)
    - name: ðŸ” Analyze & Fix Build Configuration
      id: sdk_check
      run: |
        echo "=== BUILD CONFIGURATION ANALYSIS ==="
        
        # Find build file
        BUILD_FILE="app/build.gradle.kts"
        if [ ! -f "$BUILD_FILE" ]; then
          echo "âŒ ERROR: Build file not found at $BUILD_FILE"
          exit 1
        fi
        
        # Backup original
        cp "$BUILD_FILE" "$BUILD_FILE.backup"
        echo "âœ… Backup created: $BUILD_FILE.backup"
        
        # Extract current minSdk
        if grep -q "minSdk\s*=" "$BUILD_FILE"; then
          CURRENT_SDK=$(grep "minSdk\s*=" "$BUILD_FILE" | grep -o '[0-9][0-9]*' | head -1)
          PATTERN="minSdk"
        elif grep -q "minSdkVersion" "$BUILD_FILE"; then
          CURRENT_SDK=$(grep "minSdkVersion" "$BUILD_FILE" | grep -o '[0-9][0-9]*' | head -1)
          PATTERN="minSdkVersion"
        else
          echo "âš ï¸  No minSdk found, defaulting to 23"
          CURRENT_SDK="23"
          PATTERN="none"
        fi
        
        echo "Current minSdk: $CURRENT_SDK"
        echo "Pattern detected: $PATTERN"
        
        # Determine target SDK (prioritize compatibility)
        if [ "$CURRENT_SDK" -gt 23 ]; then
          echo "âš ï¸  Current minSdk ($CURRENT_SDK) > 23"
          echo "Testing with minSdk = 23 for compatibility"
          TARGET_SDK=23
          SDK_CHANGED=true
        else
          echo "âœ… Current minSdk ($CURRENT_SDK) is compatible with Android 6.0"
          TARGET_SDK="$CURRENT_SDK"
          SDK_CHANGED=false
        fi
        
        # Apply change if needed
        if [ "$SDK_CHANGED" = true ] && [ "$PATTERN" != "none" ]; then
          sed -i "s/$PATTERN\s*=\s*$CURRENT_SDK/$PATTERN = $TARGET_SDK/" "$BUILD_FILE"
          echo "ðŸ”§ Updated $PATTERN from $CURRENT_SDK to $TARGET_SDK"
        fi
        
        # Output variables for later steps
        echo "CURRENT_SDK=$CURRENT_SDK" >> $GITHUB_OUTPUT
        echo "TARGET_SDK=$TARGET_SDK" >> $GITHUB_OUTPUT
        echo "SDK_CHANGED=$SDK_CHANGED" >> $GITHUB_OUTPUT
        echo "BUILD_FILE=$BUILD_FILE" >> $GITHUB_OUTPUT
        
        echo "=== ANALYSIS COMPLETE ==="
    
    # 5. GRADLE BUILD with error handling
    - name: ðŸ—ï¸ Build APK
      id: build
      continue-on-error: false
      run: |
        echo "=== STARTING BUILD ==="
        
        # Make gradlew executable
        chmod +x gradlew
        
        # Build with detailed output
        ./gradlew assembleRelease --stacktrace --no-daemon
        
        # Verify APK exists
        APK_PATH="app/build/outputs/apk/release/app-release.apk"
        if [ -f "$APK_PATH" ]; then
          APK_SIZE=$(stat -f%z "$APK_PATH" 2>/dev/null || stat -c%s "$APK_PATH")
          echo "âœ… APK generated: $APK_PATH ($((APK_SIZE/1024/1024)) MB)"
          echo "APK_PATH=$APK_PATH" >> $GITHUB_OUTPUT
        else
          echo "âŒ ERROR: APK not found at $APK_PATH"
          ls -la app/build/outputs/apk/release/ || true
          exit 1
        fi
        
    # 6. RESTORE original build file if changed
    - name: â†©ï¸ Restore Original Build Config
      if: steps.sdk_check.outputs.SDK_CHANGED == 'true'
      run: |
        echo "Restoring original build configuration..."
        mv "${{ steps.sdk_check.outputs.BUILD_FILE }}.backup" "${{ steps.sdk_check.outputs.BUILD_FILE }}"
        echo "âœ… Original configuration restored"
        
    # 7. UPLOAD ARTIFACTS
    - name: ðŸ“¤ Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: stormy-android6-apk
        path: ${{ steps.build.outputs.APK_PATH }}
        retention-days: 30
        if-no-files-found: error
        
    # 8. CREATE RELEASE on tag push (optional automation)
    - name: ðŸ·ï¸ Create GitHub Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ steps.build.outputs.APK_PATH }}
        generate_release_notes: true
        prerelease: ${{ contains(github.ref, '-alpha') || contains(github.ref, '-beta') }}
        
    # 9. CLEANUP
    - name: ðŸ§¹ Cleanup
      if: always()
      run: |
        echo "=== CLEANUP ==="
        echo "Build status: ${{ job.status }}"
        
        # Remove backup files
        find . -name "*.backup" -type f -delete 2>/dev/null || true
        
        # Gradle cleanup
        ./gradlew --stop 2>/dev/null || true
