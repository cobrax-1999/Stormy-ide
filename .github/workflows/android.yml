name: Build APK for Android 6.0

on:
  push:
    branches: [ main, master ]  # Auto-triggers on push to these branches
  pull_request:
    branches: [ main, master ]   # Optional: also runs on PRs

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'

    - name: Set up Android SDK
      uses: android-actions/setup-android@v3

    - name: Check current minSdk and configure
      id: check_sdk
      run: |
        # Find the current minSdk value in the build file
        if grep -q "minSdk = " app/build.gradle.kts; then
          CURRENT_SDK=$(grep "minSdk = " app/build.gradle.kts | grep -o '[0-9]*')
        elif grep -q "minSdkVersion" app/build.gradle.kts; then
          CURRENT_SDK=$(grep "minSdkVersion" app/build.gradle.kts | grep -o '[0-9]*' | head -1)
        else
          echo "Could not find minSdk in build.gradle.kts"
          exit 1
        fi
        
        echo "Current minSdk is: $CURRENT_SDK"
        echo "CURRENT_SDK=$CURRENT_SDK" >> $GITHUB_OUTPUT
        
        # Only change if current SDK is > 23
        if [ "$CURRENT_SDK" -gt 23 ]; then
          echo "Changing minSdk from $CURRENT_SDK to 23 for this build"
          cp app/build.gradle.kts app/build.gradle.kts.backup
          sed -i "s/minSdk = $CURRENT_SDK/minSdk = 23/" app/build.gradle.kts || \
          sed -i "s/minSdkVersion = $CURRENT_SDK/minSdkVersion = 23/" app/build.gradle.kts || \
          echo "Note: Build file structure may differ. Check if minSdk was updated."
        else
          echo "No change needed. Current minSdk ($CURRENT_SDK) is compatible with Android 6.0."
        fi

    - name: Build Release APK
      run: |
        chmod +x gradlew
        ./gradlew assembleRelease

    - name: Restore original build file (if changed)
      if: steps.check_sdk.outputs.CURRENT_SDK > 23
      run: |
        mv app/build.gradle.kts.backup app/build.gradle.kts
        echo "Restored original build.gradle.kts"

    - name: Upload APK Artifact
      if: success()  # Only upload if build succeeded
      uses: actions/upload-artifact@v4
      with:
        name: stormy-apk-android6
        path: app/build/outputs/apk/release/app-release.apk
        retention-days: 7
